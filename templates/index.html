<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

    <title>Demo</title>

    <style type="text/css">
      #map {
        height: 85vh;
      }

      #footer {
        padding-top: 25px;
      }

      .image {
        max-width: 800px;
      }
    </style>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

    <div class="container">
      <div class="row">
        <h3><a href="/">Поиск дефектов на защитных очках</a></h3>

        {% if error %}
          <div class="alert alert-danger" role="alert">
            {{ error }}
          </div>
        {% endif %}
      </div>
      <div class="row">
        <div class="col-sm">
          <form action="/upload" method="POST" enctype="multipart/form-data">
            <div class="form-group">
              <label for="file">Выберите фоторафию для обработки</label>
              <input type="file" class="form-control-file" name="file" id="file" accept="image/*">
            </div>
            <div>
              <button type="submit" class="btn btn-primary">Submit</button>
            </div>
          </form>
        </div>
      </div>
      {% if uid %}
      <div class="row">
        <div class="col-sm">
          <div id="progress">Валидация...</div>
          <div id="result"></div>
          <div id="spinner">
            <img src="/static/spinner.gif" width="50" />
          </div>
          <div id="segmentation"><img class="image"/></div>
        </div>

        <script type="text/javascript">
          $(document).ready(function () {
            var timer_id = null;
            var validated = false;
            var segmented = false;

            function stop() {
              $("#spinner").hide();
              clearTimeout(timer_id);
            }

            function update_result() {
              var uid = "{{ uid }}";

              $.get("/result/" + uid, function(data) {
                if (!validated) {
                  if (data.hasOwnProperty("input_validation")) {
                    if (data["input_validation"] === true) {
                      $("#progress").text("Сегментация...")
                      validated = true;
                      return
                    } else {
                      $("#progress").text("На изображении нет защитных очков");
                      stop();
                    }
                  }
                }

                if (!segmented) {
                  if (data.hasOwnProperty("segmented_image")) {
                    $("#progress").text("Поиск дефектов...")
                    $("#segmentation img").attr("src", data["segmented_image"])
                    segmented = true;
                    return
                  }
                }
              });
            }

            timer_id = setInterval(update_result, 2000);
          });
        </script>
      </div>
      {% endif %}
      {% if image_url %}
      <div class="row">
        <div class="col-sm">
          <img src="{{ image_url }}" class="image"/>
        </div>
      </div>
      {% endif %}
    </div>

    {% if price %}
      <div class="container">
        <h3>≈ £{{ price }}/night</h3>

        <div class="row">
          Similar (by room type and bedrooms) realty rent price heatmap:
          <div id="map" class="col-md-12">
          </div>
        </div>
      </div>
    {% endif %}

    <div class="container" id="footer">
      <div class="row">
        <div class="col-md-12 text-center">
          <h5>Goggles Defect Detection Team @ MADE 2021</h5>
        </div>
      </div>
    </div>
  </body>
</html>
